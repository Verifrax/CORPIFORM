#!/usr/bin/env bash
set -euo pipefail

# TEST: MUST ENFORCE SCOPE
# Verifies that scope mismatch between authority and command is refused.

export SYSTEM_FINGERPRINT="test-fingerprint"
export BUILD_HASH="test-build-hash"
export CORPIFORM_VERSION="v0.test"
export DENIAL_SIGNING_KEY="fixtures/keys/denial.key"
export EXECUTION_CUSTODIAN="test-custodian"

export EXECUTION_COMMAND_PATH="fixtures/scope_violation/command.json"
export AUTHORITY_SEAL_PATH="fixtures/scope_violation/seal.json"

mkdir -p ledger/denials ledger/locks

# Must be refused
if runtime/runner/run.sh >/dev/null 2>&1; then
  echo "FAIL: execution succeeded despite scope violation"
  exit 1
fi

echo "PASS: scope violation refused"
exit 0
