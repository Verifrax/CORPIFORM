#!/usr/bin/env bash
set -euo pipefail

# TEST: MUST EMIT RECEIPT
# Verifies that a successful execution emits exactly one receipt.

export EXECUTION_COMMAND_PATH="fixtures/valid_authority/command.json"
export AUTHORITY_SEAL_PATH="fixtures/valid_authority/seal.json"
export EXECUTION_CUSTODIAN="test-custodian"
export SYSTEM_FINGERPRINT="test-fingerprint"
export BUILD_HASH="test-build-hash"
export CORPIFORM_VERSION="v0.test"
export RECEIPT_SIGNING_KEY="fixtures/keys/receipt.key"
export DENIAL_SIGNING_KEY="fixtures/keys/denial.key"

RECEIPTS_BEFORE=$(ls ledger/receipts 2>/dev/null | wc -l)

if ! runtime/runner/run.sh >/dev/null 2>&1; then
  echo "FAIL: execution did not succeed"
  exit 1
fi

RECEIPTS_AFTER=$(ls ledger/receipts 2>/dev/null | wc -l)

if [[ "$((RECEIPTS_AFTER - RECEIPTS_BEFORE))" -ne 1 ]]; then
  echo "FAIL: receipt not emitted exactly once"
  exit 1
fi

echo "PASS: receipt emitted exactly once"
exit 0
